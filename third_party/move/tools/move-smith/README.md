# MoveSmith

A Move source code level fuzzer.

# Usage

Make sure you have all the necessary [dependencies](#dependencies).

## Fuzzing

To start fuzzing, run
```bash
cargo fuzz run <fuzz_target>
```

Currently we have two fuzz targets in `fuzz/fuzz_targets`:

* `compile_v1_only`: compiles the generated Move programs using compiler V1
* `transactional`: run the generated Move programs as transactional tests so that we can cover compiler V1, V2, and the VM


If some unwanted crash stopped the fuzzer and you want to ignore it, use:
```bash
cargo fuzz run <fuzz_target> -- -fork=1 -ignore_crashes=1
```

All crash triggering inputs are stored in `fuzz/artifacts/<fuzz_target>`.  However, the inputs are raw bytes. To convert raw bytes to Move, you can use:
```bash
cargo run --bin raw2move < fuzz/artifacts/<fuzz_target>/<input_file>
```

## Static generator

Instead of directly running the fuzzing session, you can also use the static generator with a fixed seed to generate a number of Move files/packages. This could be helpful to debug the fuzzer or to use the generated files for other purposes.

The generator can be used by `cargo run --bin generator -- <Options>` and available options are:

```
Options:
  -o, --output-dir <OUTPUT_DIR>  The output directory to store the generated Move files
  -s, --seed <SEED>              An optional number as seed, the default should be 0 [default: 0]
  -n, --num-files <NUM_FILES>    An optional number as the number of files to generate, the default should be 100 [default: 100]
  -p, --package                  A boolean flag to create a package, default to false
```
## Coverage

After running a fuzzing session, the coverage of all stored corpus can be generated by:
```bash
./scripts/coverage.sh <fuzz_target> [base_dir]
```

If the fuzzing session was run on the same machine, you can ignore `base_dir`.

If you want to generate the coverage from a different corpus (e.g. generated from another machine),
use the `base_dir` to specify the directory that contains `fuzz/corpus/<fuzz_target>` where the inputs were stored.

This will create an HTML report at `[base_dir/]coverage/<fuzz_target>/index.html`.

## Debugging

## Compilation

The script `./scripts/check_output.sh` is a helper for checking the generated programs.
By default it generates 10 Move packages stored in `output/`, compiles them with compiler V1, and reports any error encountered.
Use `./scripts/check_output.sh N` to generate `N` packages instead.

## Transactional test

To execute the generated Move programs as transactional tests, use the script:
```
./scripts/transactional-test.sh N
```

This script will generate `N` programs under `third_party/move/move-compiler-v2/transactional-tests/tests/move-smith`.
It will than apply a patch to the test harness to only run with the newly generated files.

# Dependencies

## cargo-fuzz

[cargo-fuzz][cargo-fuzz] provides many handy commands for running fuzzing. Install with:
```bash
cargo install cargo-fuzz
```

## Nightly Toolchain

The nightly rust toolchain is required for instrumenting the code. Install with:
```bash
rustup install nightly
```

To overwrite the top-level `rust-toolchain.toml`, use:
```bash
rustup override set nightly
```

## [Optional] Coverage

To generate human-readable coverage reports, we need `llvm` coverage tools.
They can be installed with:
```bash
rustup component add --toolchain nightly llvm-tools-preview
```

# Code Structure

```
.
├── Cargo.toml
├── README.md
├── fuzz
│   ├── Cargo.toml
│   ├── artifacts                 # The inputs that trigger crashes (created after a fuzzing session starts)
│   ├── corpus                    # The corpus of inputs for all fuzz targets (created after a fuzzing session starts)
│   ├── coverage                  # Stores the aggregated raw coverage files (created after collecting coverage)
│   └── fuzz_targets
│       ├── compile_v1_only.rs    # Basic fuzzer that only generates and compiles a module with compiler V1
│       └── transactional.rs      # Run the generated Move programs as transactional tests to cover V1, V2, and the VM
├── scripts
│   ├── check_output.sh           # Generate Move programs/packages and try to compile them
│   ├── coverage.sh               # Collect coverage and generate human-readable reports.
│   ├── coverage_graph.py         # Parses libfuzzer output and draw a coverage-over-time graph.
│   ├── transactional-test.sh     # Generate Move programs and execute them as transactional tests.
│   └── transactional-tests.patch # Disables all other tests and only run MoveSmith generated ones.
├── src
│   ├── ast.rs                    # The AST for the Move language by the fuzzer
│   ├── cli
│   │   ├── generator.rs          # The static generator for debugging
│   │   └── raw2move.rs           # Converts raw bytes from stdin to a Move program
│   ├── codegen.rs                # Converts the AST to textual Move code
│   ├── config.rs                 # Fuzzer configurations
│   ├── lib.rs
│   ├── move_smith.rs             # The core generation logic
│   ├── names.rs                  # Manages identifiers and scoping
│   ├── types.rs                  # Manages type mapping
│   └── utils.rs                  # Connects to compilers & VM
└── tests
    └── integration_test.rs
```


[cargo-fuzz]: https://github.com/rust-fuzz/cargo-fuzz
