//# publish
module 0x1::M
struct R has key
  v: vector<u64>

public fun publish(l0: &signer)
    local l1: vector<u64>
    ld_u64 100
    vec_pack <u64>, 1
    st_loc l1
    mut_borrow_loc l1
    ld_u64 200
    vec_push_back <u64>
    move_loc l0
    move_loc l1
    pack R
    move_to R
    ret

public fun borrow_and_modify(l0: address) acquires R
    local l1: &mut R
    local l2: &mut vector<u64>
    move_loc l0
    mut_borrow_global R
    st_loc l1
    move_loc l1
    mut_borrow_field R, v
    st_loc l2
    ld_u64 300
    move_loc l2
    ld_u64 0
    vec_mut_borrow <u64>
    write_ref
    ret

public fun verify_effects(l0: address) acquires R
    local l1: &R
    local l2: &vector<u64>
    move_loc l0
    borrow_global R
    st_loc l1
    move_loc l1
    borrow_field R, v
    st_loc l2
    move_loc l2
    ld_u64 0
    vec_borrow <u64>
    read_ref
    ld_u64 300
    eq
    not
    br_false l0
    ld_u64 1000
    abort
l0: ret



//# run --signers 0x1
script
use 0x1::M
entry public fun main(l0: signer)
    borrow_loc l0
    call M::publish
    ret



//# run --signers 0x1
script
use 0x1::M
use 0x1::signer
entry public fun main(l0: signer)
    borrow_loc l0
    call signer::address_of
    call M::borrow_and_modify
    ret



//# run --signers 0x1
script
use 0x1::M
use 0x1::signer
entry public fun main(l0: signer)
    borrow_loc l0
    call signer::address_of
    call M::verify_effects
    ret
