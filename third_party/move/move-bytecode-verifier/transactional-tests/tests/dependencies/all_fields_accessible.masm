//# publish
module 0x42::M
struct A
  x: u64

struct B has drop
  y: u64

public fun a(l0: u64): A
    move_loc l0
    pack A
    ret

public fun b(l0: u64): B
    move_loc l0
    pack B
    ret

public fun set_a_with_b(l0: &mut A, l1: &B)
    local l2: &mut u64
    local l3: &u64
    copy_loc l0
    mut_borrow_field A, x
    st_loc l2
    copy_loc l1
    borrow_field B, y
    st_loc l3
    move_loc l3
    read_ref
    move_loc l2
    write_ref
    move_loc l0
    pop
    move_loc l1
    pop
    ret

public fun set_b_with_a(l0: &mut B, l1: &A)
    local l2: &u64
    local l3: &mut u64
    copy_loc l0
    mut_borrow_field B, y
    st_loc l3
    copy_loc l1
    borrow_field A, x
    st_loc l2
    move_loc l2
    read_ref
    move_loc l3
    write_ref
    move_loc l1
    pop
    move_loc l0
    pop
    ret

public fun destroy_a(l0: A)
    local l1: u64
    move_loc l0
    unpack A
    st_loc l1
    ret



//# run
script
use 0x42::M
entry public fun main()
    local l0: M::A
    local l1: &M::A
    local l2: &mut M::A
    local l3: M::B
    local l4: &M::B
    local l5: &mut M::B
    ld_u64 0
    call M::a
    st_loc l0
    ld_u64 1
    call M::b
    st_loc l3
    mut_borrow_loc l0
    st_loc l2
    borrow_loc l3
    st_loc l4
    move_loc l2
    move_loc l4
    call M::set_a_with_b
    borrow_loc l0
    st_loc l1
    mut_borrow_loc l3
    st_loc l5
    move_loc l5
    move_loc l1
    call M::set_b_with_a
    move_loc l0
    call M::destroy_a
    ret