//# publish
module 0x1::Tester
struct X has key
  f: u64

fun bump_and_give(l0: &mut X, l1: &u64): &u64
    move_loc l1
    pop
    copy_loc l0
    mut_borrow_field X, f
    read_ref
    ld_u64 1
    add
    copy_loc l0
    mut_borrow_field X, f
    write_ref
    move_loc l0
    borrow_field X, f
    ret

fun contrived_example(l0: &mut u64)
    local l1: X
    local l2: u64
    local l3: &u64
    ld_u64 0
    pack X
    st_loc l1
    ld_u64 100
    st_loc l2
    mut_borrow_loc l1
    borrow_loc l2
    call bump_and_give
    st_loc l3
    copy_loc l3
    read_ref
    borrow_loc l1
    borrow_field X, f
    read_ref
    eq
    not
    br_false l0
    ld_u64 42
    abort
l0: move_loc l3
    read_ref
    move_loc l0
    write_ref
    move_loc l1
    unpack X
    st_loc l2
    ret