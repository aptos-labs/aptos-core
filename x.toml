[grcov.installer]
version = "0.8.2"

[system-tests]
smoke-test = { path = "smoke-test" }
testcases = { path = "testsuite/testcases" }

[fix]

[clippy]
allowed = [
    # Deriving Arbitrary often causes this warning to show up.
    "clippy::unit_arg",
    "clippy::eval-order-dependence",
    "clippy::new-without-default",
    "clippy::rc_buffer",
    "clippy::upper_case_acronyms",
    "clippy::len-without-is-empty",
    "clippy::from-iter-instead-of-collect",
    "clippy::while-let-on-iterator",
    "clippy::bool-assert-comparison",
    "clippy::needless-collect",
    "clippy::enum-variant-names",
    "clippy::self-named-constructors",
]
warn = [
    "clippy::wildcard_dependencies",
]

exact-versions = true
platforms = [
    "x86_64-unknown-linux-gnu",
    "x86_64-apple-darwin",
]

# This follows the same syntax as CargoOptionsSummary in guppy.
[summaries.default]
resolver = "2"
include-dev = false
initials-platform = "standard"

[summaries.default.target-platform]
triple = "x86_64-unknown-linux-gnu"
target-features = "all"

[summaries.default.host-platform]
triple = "x86_64-unknown-linux-gnu"
target-features = "all"

[summaries.default.omitted-packages]
workspace-members = [

]

[summaries.full]
version = "v2"
include-dev = true
initials-platform = "standard"
# Don't set target or host platforms, or omitted packages, for the full set.

[workspace]

# Regex for allowed characters in paths. Regex must have ^ and $ anchors.
allowed-paths = "^([a-zA-Z0-9._\\-/@:]|-)+$"

license-exceptions = [
    "terraform/**/*",
]

[workspace.enforced-attributes]
authors = ["Aptos Labs <opensource@aptoslabs.com>"]
license = "Apache-2.0"

[workspace.banned-deps.direct]
lazy_static = "use once_cell::sync::Lazy instead"

[workspace.banned-deps.default-build]
criterion = "criterion is only for benchmarks"
proptest = "proptest is only for testing and fuzzing"

[workspace.direct-dep-dups]
allow = [
]

[workspace.overlay]
features = ["failpoints", "fuzzing"]

# This is a list of test-only members. These are workspace members that do not form part of the main
# Aptos production codebase, and are only used to verify correctness and/or performance.
#
# *** IMPORTANT ***
#
# Published developer tools (e.g. Move compiler) ARE part of the production Aptos codebase.
# They should be listed in the root Cargo.toml's default-members, not here!
#
# Before adding a new crate to this list, ensure that it is *actually* test-only. If not, add it
# (or a crate that depends on it) to the root Cargo.toml's default-members list!
#
# For more, see the "Conditional compilation for tests" section in documentation/coding_guidelines.md.
[workspace.test-only]
members = [
    # Please keep this list in alphabetical order!

    "testcases",
    "aptos-faucet-cli",
    "aptos-fuzz",
    "aptos-fuzzer",
    "aptos-proptest-helpers",
    "aptos-retrier",
    "aptos-rosetta-cli",
    "aptos-transaction-benchmarks",
    "aptos-writeset-generator",
    "executor-benchmark",
    "executor-test-helpers",
    "forge",
    "forge-cli",
    "generate-format",
    "language-e2e-tests",
    "language-e2e-testsuite",
    "memsocket",
    "move-examples",
    "peer-monitoring-service-client", # This will be removed once the peer monitoring service is plugged in
    "peer-monitoring-service-server", # This will be removed once the peer monitoring service is plugged in
    "peer-monitoring-service-types", # This will be removed once the peer monitoring service is plugged in
    "smoke-test",
    "x",
    "x-core",
    "x-lint",

    # Please keep this list in alphabetical order!
]

[workspace.move-to-aptos-deps]
# By default, all crates in the language directory are considered Move crates
# and are forbidden from depending on any Aptos crates.
#
# Adding a crate's name to this list will mark it as a Aptos crate so that the
# linter will not impose said restriction on it.
#
# Note: if your crate is indeed a Move crate and you are getting the linter
# yelling at you, you should redesign your crate and properly remove that
# dependency, instead of adding the crate to this list and silencing the lint.
aptos_crates_in_language = [
]
# A special set of aptos crates Move crates are allowed to depend on.
#
# You should not add new entries to this list unless you have a rare justifiable
# reason. (read: Just don't.)
#
# Particularly, please do not abuse this to silence the lint when it complains
# about Move crates depending on Aptos ones. Again, you should instead fix
# the design of your crate so it doesn't have to depend on Aptos.
exclude = [

]

# Interesting subsets of the workspace, These are used for generating and
# checking dependency summaries.

[subsets.lsr]
# The Aptos safety rules TCB.
root-members = [
    "safety-rules",
]

[subsets.release]
# The Aptos release binaries
root-members = [
    "backup-cli",
    "db-bootstrapper",
    "aptos",
    "aptos-node",
    "aptos-operational-tool",
    "safety-rules",
]

# ---
# Determinator rules
# ---

# CI-related files. TODO: maybe have separate rules for local and CI?
[[determinator.path-rule]]
globs = [".circleci/**/*", ".github/**/*", "codecov.yml"]
mark-changed = "all"

# Core devtools files.
[[determinator.path-rule]]
globs = [".config/nextest.toml", "scripts/dev_setup.sh", "x.toml", ".node-version", ".prettierrc", "Makefile.toml", "lefthook.yaml"]
mark-changed = "all"

[[determinator.path-rule]]
# Ignore website and other ancillary files, and scripts not listed above.
globs = ["CODEOWNERS","dashboards/**", "developer-docs-site/**/*", "documentation/**/*", "docker/**/*", "language/documentation/**/*", "specifications/**/*", "scripts/**/*", "terraform/**/*", "crowdin.yml"]
mark-changed = []

[[determinator.path-rule]]
# Ignore ecosytem typescript
globs = ["ecosystem/typescript/**/*", "ecosystem/python/**/*", "ecosystem/web-wallet/**/*", "ecosystem/platform/**/*", "ecosystem/indexer-server/*"]
mark-changed = []

[[determinator.path-rule]]
# A bunch of images that should be ignored, I guess.
globs = [".assets/aptos_banner.png", ".assets/aptos.png", "storage/data.png"]
mark-changed = []

[[determinator.path-rule]]
# Ignore *.md documentation
globs = ["*.md"]
mark-changed = []

[[determinator.path-rule]]
# Required by get_stdlib_script_abis in transaction-builder-generator.
globs = ["aptos-move/framework/DPN/releases/artifacts/current/**/*"]
mark-changed = ["transaction-builder-generator"]
post-rule = "skip-rules"

[[determinator.package-rule]]
# x controls the build process, so if it changes, build everything.
on-affected = ["x"]
mark-changed = "all"
