<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <link rel="stylesheet" href="assets/style.css">
    <script>
        function copyTable(btn) {
            const table = btn.closest('.table-wrapper').querySelector('table');
            const rows = Array.from(table.rows);
            const text = rows.map(row =>
                Array.from(row.cells).map(cell => cell.textContent.trim()).join('\t')
            ).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 1000);
            }).catch(() => {
                const orig = btn.textContent;
                btn.textContent = 'Failed';
                setTimeout(() => btn.textContent = orig, 1000);
            });
        }

        function exportTableCsv(btn) {
            const wrapper = btn.closest('.table-wrapper');
            const table = wrapper.querySelector('table');
            const rows = Array.from(table.rows);
            const csv = rows.map(row =>
                Array.from(row.cells).map(cell => {
                    let val = cell.textContent.trim();
                    // Escape quotes and wrap in quotes if contains comma or quote
                    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                        val = '"' + val.replace(/"/g, '""') + '"';
                    }
                    return val;
                }).join(',')
            ).join('\n');

            // Get table name from data-name attribute
            const name = table.dataset.name || 'table';

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name + '.csv';
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        function sortTable(th, colIndex) {
            const table = th.closest('table');
            const tbody = table.tBodies[0] || table;
            const rows = Array.from(tbody.querySelectorAll('tr')).slice(1); // skip header

            if (rows.length === 0) return;

            const wasAsc = th.classList.contains('sort-asc');
            const wasDesc = th.classList.contains('sort-desc');
            const wasSorted = wasAsc || wasDesc;

            // Check if column is marked to default to ascending (text columns)
            const defaultAsc = th.hasAttribute('data-sort-asc');

            // Clear other sort indicators
            th.closest('tr').querySelectorAll('th').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });

            // Determine new sort direction
            // - If already sorted, toggle direction
            // - If not sorted: use data-sort-asc attribute to determine default
            let sortDesc;
            if (wasSorted) {
                sortDesc = wasAsc; // toggle: was asc -> now desc
            } else {
                sortDesc = !defaultAsc; // default desc unless marked with data-sort-asc
            }

            th.classList.add(sortDesc ? 'sort-desc' : 'sort-asc');

            // Check if column is marked as numeric
            const isNumeric = th.hasAttribute('data-sort-num');

            rows.sort((a, b) => {
                const aVal = a.cells[colIndex]?.textContent.trim() || '';
                const bVal = b.cells[colIndex]?.textContent.trim() || '';

                if (isNumeric) {
                    // Handle "/" placeholder and other non-numeric values as 0
                    const parseNum = (v) => {
                        const n = parseFloat(v.replace(/[,%]/g, ''));
                        return isNaN(n) ? 0 : n;
                    };
                    const aNum = parseNum(aVal);
                    const bNum = parseNum(bVal);
                    return sortDesc ? bNum - aNum : aNum - bNum;
                }
                // String comparison
                return sortDesc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function makeTablesSortable() {
            const tables = document.querySelectorAll('table');
            tables.forEach((table) => {
                if (table.id === 'summary-table') return;
                const headerRow = table.querySelector('tr');
                if (!headerRow) return;
                headerRow.querySelectorAll('th').forEach((th, colIndex) => {
                    th.classList.add('sortable');
                    th.onclick = () => sortTable(th, colIndex);
                });
            });
        }

        function wrapTablesWithCopyButton() {
            const tables = document.querySelectorAll('table');
            tables.forEach((table) => {
                if (table.id === 'summary-table') return;
                if (table.parentElement.classList.contains('table-wrapper')) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';

                const footer = document.createElement('div');
                footer.className = 'table-footer';

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = function () { copyTable(this); };

                const csvBtn = document.createElement('button');
                csvBtn.className = 'copy-btn';
                csvBtn.textContent = 'CSV';
                csvBtn.style.marginLeft = '4px';
                csvBtn.onclick = function () { exportTableCsv(this); };

                footer.appendChild(copyBtn);
                footer.appendChild(csvBtn);
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
                wrapper.appendChild(footer);
            });
        }
    </script>
</head>

<body onload="wrapTablesWithCopyButton(); makeTablesSortable();">
    <header>
        <h1>{{title}}</h1>
    </header>

    <details open>
        <summary>
            <h2>Summary</h2>
        </summary>
        <p>
            This summary corresponds to the <code>FeeStatement</code> event emitted by the transaction.
        </p>
        <table id="summary-table">
            <tr>
                <th>Category</th>
                <th style="text-align: right">Cost</th>
                <th>Unit</th>
                <th>Description</th>
            </tr>
            <tr>
                <td class="category-label">Execution Gas</td>
                <td style="text-align: right">{{summary-execution-gas}}</td>
                <td>gas units</td>
                <td>Transient resources for execution, like CPU time or memory</td>
            </tr>
            <tr>
                <td class="category-label">IO Gas</td>
                <td style="text-align: right">{{summary-io-gas}}</td>
                <td>gas units</td>
                <td>Storage reads and writes</td>
            </tr>
            <tr>
                <td class="category-label">Storage Fee</td>
                <td style="text-align: right">{{summary-storage-fee}}</td>
                <td>APT</td>
                <td>Cost for new or expanded storage slots</td>
            </tr>
            <tr>
                <td class="category-label">Storage Refund</td>
                <td style="text-align: right">{{summary-storage-refund}}</td>
                <td>APT</td>
                <td>Refund for deleted storage slots</td>
            </tr>
        </table>
        <p style="font-size: 0.9em; color: #666;">
            <b>Note:</b> Values may differ slightly from the <code>FeeStatement</code> due to rounding.
        </p>
    </details>

    <details open>
        <summary>
            <h2>Flamegraphs</h2>
        </summary>
        {{#if graph-exec-io}}
        <object data="assets/exec_io.svg" type="image/svg+xml" class="flamegraph"></object>
        {{else}}
        (No execution & IO graph to show.)<br>
        {{/if}}

        {{#if graph-storage}}
        <object data="assets/storage.svg" type="image/svg+xml" class="flamegraph"></object>
        {{else}}
        (No storage graph to show.)
        {{/if}}
    </details>

    <details open>
        <summary>
            <h2>Cost Break-down</h2>
        </summary>
        <p>The Aptos network charges a transaction in three parts: (1) execution, (2) IO, and (3) storage.
            Execution and IO are measured in gas units; storage is measured in APT.</p>

        <details class="subsection" open>
            <summary>
                <h3>Execution ({{summary-execution-gas}} gas units)</h3>
            </summary>
            <p>Execution costs cover transient resources used for executing the transaction,
                such as CPU time or memory usage.</p>

            <h4>Intrinsic Cost</h4>
            {{intrinsic}} gas units{{#if intrinsic-percentage}}, {{intrinsic-percentage}} of execution gas.{{/if}}

            {{#if keyless}}
            <h4>Keyless Cost</h4>
            {{keyless}} gas units, {{keyless-percentage}} of execution gas.
            {{/if}}

            {{#if slh_dsa_sha2_128s}}
            <h4>SLH-DSA-SHA2-128s Cost</h4>
            {{slh_dsa_sha2_128s}} gas units, {{slh_dsa_sha2_128s-percentage}} of execution gas.
            {{/if}}

            <h4>Dependencies</h4>
            {{#if deps}}
            <table data-name="exec_dependencies">
                <tr>
                    <th data-sort-asc>Name</th>
                    <th style="text-align: right" data-sort-num>Size in Bytes</th>
                    <th style="text-align: right" data-sort-num>Cost in Gas Units</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each deps}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{size}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No dependencies to show. System dependencies are excluded.)
            {{/if}}

            <h4>Operations</h4>
            {{#if ops}}
            <table data-name="exec_operations">
                <tr>
                    <th data-sort-asc>Operation</th>
                    <th style="text-align: right" data-sort-num>Number of Hits</th>
                    <th style="text-align: right" data-sort-num>Cost in Gas Units</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each ops}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No operations to show.)
            {{/if}}
            <br />
            {{#if methods}}
            <table data-name="exec_methods_total">
                <tr>
                    <th data-sort-asc>Methods (gas including children)</th>
                    <th style="text-align: right" data-sort-num>Number of Hits</th>
                    <th style="text-align: right" data-sort-num>Cost in Gas Units</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each methods}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No methods to show.)
            {{/if}}
            <br />
            {{#if methods_self}}
            <table data-name="exec_methods_self">
                <tr>
                    <th data-sort-asc>Methods (only local gas)</th>
                    <th style="text-align: right" data-sort-num>Number of Hits</th>
                    <th style="text-align: right" data-sort-num>Cost in Gas Units</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each methods_self}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No methods to show.)
            {{/if}}
        </details>

        <details class="subsection" open>
            <summary>
                <h3>IO ({{summary-io-gas}} gas units)</h3>
            </summary>
            <p>IO costs cover reading and writing data to storage.</p>

            <h4>State Reads</h4>
            {{#if reads}}
            <table data-name="io_state_reads">
                <tr>
                    <th data-sort-asc>Resource Name</th>
                    <th style="text-align: right" data-sort-num>Number of Hits</th>
                    <th style="text-align: right" data-sort-num>Cost in Gas Units</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each reads}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No reads to show.)
            {{/if}}
            <h4>Transaction Write <span class="info-tip"
                    title="Cost of writing the transaction itself (authentication header + payload) to the ledger history">â“˜</span>
            </h4>
            <table data-name="io_transaction_write">
                <tr>
                    <th style="text-align: right" data-sort-num>Cost in Gas Units</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#with transaction_write}}
                <tr>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/with}}
            </table>

            <h4>Event Writes</h4>
            {{#if event_writes}}
            <table data-name="io_event_writes">
                <tr>
                    <th data-sort-asc>Event Type</th>
                    <th style="text-align: right" data-sort-num>Number of Hits</th>
                    <th style="text-align: right" data-sort-num>Cost in Gas Units</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each event_writes}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No event writes to show.)
            {{/if}}

            <h4>State Writes</h4>
            {{#if writes}}
            <table data-name="io_state_writes">
                <tr>
                    <th data-sort-asc>Resource Name</th>
                    <th style="text-align: right" data-sort-num>Number of Hits</th>
                    <th style="text-align: right" data-sort-num>Cost in Gas Units</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each writes}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No state writes to show.)
            {{/if}}
        </details>

        <details class="subsection" open>
            <summary>
                <h3>Storage ({{summary-storage-fee}} APT)</h3>
            </summary>
            <p>The storage fees cover the extended-term storage of states and events and are assessed at a fixed price
                in APT.</p>

            <h4>Transaction</h4>
            {{storage-txn}} APT{{#if storage-txn-percentage}}, {{storage-txn-percentage}} of the total cost for
            storage.{{/if}}
            <h4>States</h4>
            {{#if storage-writes}}
            <table data-name="storage_states">
                <tr>
                    <th data-sort-asc>Path</th>
                    <th style="text-align: right" data-sort-num>Cost in APT</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                    <th style="text-align: right" data-sort-num>Refund in APT</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each storage-writes}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{cost-percentage}}</td>
                    <td style="text-align: right">{{refund}}</td>
                    <td style="text-align: right">{{refund-percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No state changes to show.)
            {{/if}}
            <h4>Events</h4>
            {{#if storage-events}}
            <table data-name="storage_events">
                <tr>
                    <th data-sort-asc>Name</th>
                    <th style="text-align: right" data-sort-num>Cost in APT</th>
                    <th style="text-align: right" data-sort-num>Percentage</th>
                </tr>
                {{#each storage-events}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{cost-percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{storage-event-discount}}
            {{else}}
            (No events to show.)
            {{/if}}
        </details>
    </details>

    <details open>
        <summary>
            <h2>Memory Usage</h2>
        </summary>
        Peak memory usage during transaction execution: {{peak-memory-usage}}.<br><br>

        Note: This is measured in abstract value size, which does not map 1:1 to bytes.
    </details>

    <details open>
        <summary>
            <h2>Full Execution Trace</h2>
        </summary>
        <script>
            var traceDimensions = null;
            function applyTraceDimensions() {
                if (!traceDimensions) return;
                const frame = document.getElementById('trace-frame');
                if (!frame) return;
                const maxHeight = Math.max(800, window.innerHeight * 0.8);
                frame.style.height = Math.min(traceDimensions.height, maxHeight) + 'px';
                frame.style.width = Math.min(traceDimensions.width, window.innerWidth - 40) + 'px';
            }
            window.addEventListener('message', function (event) {
                // Only accept messages from our trace iframe
                const frame = document.getElementById('trace-frame');
                if (!frame || event.source !== frame.contentWindow) return;

                if (event.data && event.data.type === 'trace-dimensions') {
                    // Validate and sanitize dimensions
                    const width = Math.max(0, Math.min(Number(event.data.width) || 0, 50000));
                    const height = Math.max(0, Math.min(Number(event.data.height) || 0, 50000));
                    traceDimensions = { width: width, height: height };
                    applyTraceDimensions();
                }
            });
            window.addEventListener('resize', applyTraceDimensions);
        </script>
        {{#if trace-is-large}}
        <script>
            function loadTrace() {
                const btn = document.getElementById('load-trace-btn');
                const buttons = document.getElementById('trace-buttons');
                const container = document.getElementById('trace-container');
                const frame = document.getElementById('trace-frame');

                btn.textContent = 'Loading...';
                btn.disabled = true;

                frame.src = 'assets/trace.html';
                frame.onload = function () {
                    container.style.display = 'block';
                    buttons.style.display = 'none';
                };
                frame.onerror = function () {
                    btn.textContent = 'Failed to load trace';
                };
            }
        </script>
        <p>Large trace ({{trace-line-count}} lines)</p>
        <div id="trace-buttons">
            <button id="load-trace-btn" onclick="loadTrace()">Load Trace</button>
            <button onclick="window.open('assets/trace.html', '_blank', 'noopener')" style="margin-left: 5px;">View Raw</button>
        </div>
        <div id="trace-container" style="display: none;">
            <p><button onclick="window.open('assets/trace.html', '_blank', 'noopener')">View Raw</button></p>
            <iframe id="trace-frame" style="width: 100%; height: 400px; border: 1px solid black;"></iframe>
        </div>
        {{else}}
        <p><button onclick="window.open('assets/trace.html', '_blank', 'noopener')">View Raw</button></p>
        <iframe id="trace-frame" src="assets/trace.html" style="width: 100%; border: 1px solid black;"></iframe>
        {{/if}}
    </details>

    <footer>
        <span>Generated by the Aptos Gas Profiler{{#if git-rev}} ({{git-rev}}){{/if}}</span>
        <span>{{generated-at}}</span>
    </footer>
</body>

</html>