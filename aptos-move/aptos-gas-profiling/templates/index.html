<!-- Copyright © Aptos Foundation -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <style>
        :root {
            --accent: #2563eb;
            --accent-light: #dbeafe;
            --border: #e2e8f0;
            --text-muted: #64748b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #fff;
            color: #1e293b;
            line-height: 1.5;
            font-size: 14px;
        }

        h1 {
            border-bottom: 2px solid var(--accent);
            padding-bottom: 8px;
        }

        table {
            border-collapse: collapse;
            margin: 2px 0;
        }

        table,
        th,
        td {
            border: 1px solid var(--border);
        }

        th,
        td {
            padding: 3px 8px;
        }

        th {
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            font-weight: 600;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
        }

        th.sortable::after {
            content: ' ⇅';
            font-size: 0.7em;
            color: var(--text-muted);
        }

        th.sort-asc::after {
            content: ' ▲';
            color: var(--accent);
        }

        th.sort-desc::after {
            content: ' ▼';
            color: var(--accent);
        }

        /* Summary table category labels */
        .category-label {
            font-weight: 600;
        }

        tr:hover {
            background: var(--accent-light);
        }

        details>summary:hover {
            opacity: 0.85;
        }

        .table-wrapper {
            display: inline-block;
            margin-bottom: 12px;
        }

        .table-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 2px;
        }

        h5 {
            font-size: 0.95em;
            font-weight: 600;
            color: #475569;
            margin: 12px 0 4px 0;
        }

        button {
            font-family: inherit;
            font-size: 0.85em;
            padding: 4px 10px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            color: #475569;
        }

        button:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .copy-btn {
            padding: 1px 6px;
            font-size: 0.7em;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 3px;
            cursor: pointer;
            color: var(--text-muted);
        }

        .copy-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }

        h2 {
            background: linear-gradient(to right, #e0e7ff, #f8fafc);
            border-left: 3px solid var(--accent);
            padding: 8px 12px;
            margin-top: 30px;
            font-size: 1.1em;
        }

        h3 {
            background: #f8fafc;
            border-left: 2px solid #94a3b8;
            padding: 6px 10px;
            font-size: 1em;
            color: #475569;
        }

        h4 {
            color: #475569;
            font-size: 0.95em;
            margin: 16px 0 6px 0;
        }

        code {
            background: #f1f5f9;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        footer {
            margin-top: 40px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .flamegraph {
            width: 100%;
        }

        details {
            margin-bottom: 40px;
        }

        details>summary+* {
            margin-top: 8px;
        }

        details>summary {
            cursor: pointer;
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details>summary>h2 {
            display: block;
            margin: 0;
        }

        details>summary>h2 {
            display: flex;
            align-items: center;
        }

        details>summary>h2::before {
            content: "▶ ";
            font-size: 0.6em;
            margin-right: 6px;
            color: var(--accent);
        }

        details[open]>summary>h2::before {
            content: "▼ ";
        }

        details>summary>h3 {
            display: flex;
            align-items: center;
            margin: 0;
        }

        details>summary>h3::before {
            content: "▶ ";
            font-size: 0.6em;
            margin-right: 6px;
            color: #94a3b8;
        }

        details[open]>summary>h3::before {
            content: "▼ ";
        }

        details.subsection {
            margin-bottom: 20px;
        }
    </style>
    <script>
        function copyTable(btn) {
            const table = btn.closest('.table-wrapper').querySelector('table');
            const rows = Array.from(table.rows);
            const text = rows.map(row =>
                Array.from(row.cells).map(cell => cell.textContent.trim()).join('\t')
            ).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 1000);
            });
        }

        function sortTable(th, colIndex) {
            const table = th.closest('table');
            const tbody = table.tBodies[0] || table;
            const rows = Array.from(tbody.querySelectorAll('tr')).slice(1); // skip header

            const isAsc = th.classList.contains('sort-asc');

            // Clear other sort indicators
            th.closest('tr').querySelectorAll('th').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });

            // Set new sort direction
            th.classList.add(isAsc ? 'sort-desc' : 'sort-asc');

            rows.sort((a, b) => {
                const aVal = a.cells[colIndex]?.textContent.trim() || '';
                const bVal = b.cells[colIndex]?.textContent.trim() || '';

                // Try numeric comparison
                const aNum = parseFloat(aVal.replace(/[,%]/g, ''));
                const bNum = parseFloat(bVal.replace(/[,%]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAsc ? bNum - aNum : aNum - bNum;
                }
                // String comparison
                return isAsc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function makeTablesSortable() {
            const tables = document.querySelectorAll('table');
            tables.forEach((table, index) => {
                if (index === 0) return; // skip summary
                const headerRow = table.querySelector('tr');
                if (!headerRow) return;
                headerRow.querySelectorAll('th').forEach((th, colIndex) => {
                    th.classList.add('sortable');
                    th.onclick = () => sortTable(th, colIndex);
                });
            });
        }

        function wrapTablesWithCopyButton() {
            const tables = document.querySelectorAll('table');
            tables.forEach((table, index) => {
                // Skip summary table (first one)
                if (index === 0) return;
                if (table.parentElement.classList.contains('table-wrapper')) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';

                const footer = document.createElement('div');
                footer.className = 'table-footer';

                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.textContent = 'Copy Table';
                btn.onclick = function () { copyTable(this); };

                footer.appendChild(btn);
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
                wrapper.appendChild(footer);
            });
        }
    </script>
</head>

<body onload="wrapTablesWithCopyButton(); makeTablesSortable();">
    <header>
        <h1>{{title}}</h1>
    </header>

    <details open>
        <summary>
            <h2>Summary</h2>
        </summary>
        <p>
            This summary corresponds to the <code>FeeStatement</code> event emitted by the transaction.
        </p>
        <table>
            <tr>
                <th>Category</th>
                <th style="text-align: right">Cost</th>
                <th>Unit</th>
                <th>Description</th>
            </tr>
            <tr>
                <td class="category-label">Execution Gas</td>
                <td style="text-align: right">{{summary-execution-gas}}</td>
                <td>gas units</td>
                <td>Transient resources for execution, like CPU time or memory</td>
            </tr>
            <tr>
                <td class="category-label">IO Gas</td>
                <td style="text-align: right">{{summary-io-gas}}</td>
                <td>gas units</td>
                <td>Storage reads and writes</td>
            </tr>
            <tr>
                <td class="category-label">Storage Fee</td>
                <td style="text-align: right">{{summary-storage-fee}}</td>
                <td>APT</td>
                <td>Cost for new or expanded storage slots</td>
            </tr>
            <tr>
                <td class="category-label">Storage Refund</td>
                <td style="text-align: right">{{summary-storage-refund}}</td>
                <td>APT</td>
                <td>Refund for deleted storage slots</td>
            </tr>
        </table>
        <p style="font-size: 0.9em; color: #666;">
            <b>Note:</b> Values may differ slightly from the <code>FeeStatement</code> due to rounding.
        </p>
    </details>

    <details open>
        <summary>
            <h2>Flamegraphs</h2>
        </summary>
        {{#if graph-exec-io}}
        <object data="assets/exec_io.svg" type="image/svg+xml" class="flamegraph"></object>
        {{else}}
        (No execution & IO graph to show.)<br>
        {{/if}}

        {{#if graph-storage}}
        <object data="assets/storage.svg" type="image/svg+xml" class="flamegraph"></object>
        {{else}}
        (No storage graph to show.)
        {{/if}}
    </details>

    <details open>
        <summary>
            <h2>Cost Break-down</h2>
        </summary>
        <p>The Aptos network charges a transaction in three parts: (1) execution, (2) IO, and (3) storage.
            Execution and IO are measured in gas units; storage is measured in APT.</p>

        <details class="subsection" open>
            <summary>
                <h3>Execution ({{summary-execution-gas}} gas units)</h3>
            </summary>
            <p>Execution costs cover transient resources used for executing the transaction,
                such as CPU time or memory usage.</p>

            <h4>Intrinsic Cost</h4>
            {{intrinsic}} gas units{{#if intrinsic-percentage}}, {{intrinsic-percentage}} of execution gas.{{/if}}

            {{#if keyless}}
            <h4>Keyless Cost</h4>
            {{keyless}} gas units, {{keyless-percentage}} of execution gas.
            {{/if}}

            {{#if slh_dsa_sha2_128s}}
            <h4>SLH-DSA-SHA2-128s Cost</h4>
            {{slh_dsa_sha2_128s}} gas units, {{slh_dsa_sha2_128s-percentage}} of execution gas.
            {{/if}}

            <h4>Dependencies</h4>
            {{#if deps}}
            <table>
                <tr>
                    <th>Name</th>
                    <th style="text-align: right">Size in Bytes</th>
                    <th style="text-align: right">Cost in Gas Units</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each deps}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{size}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No dependencies to show. System dependencies are excluded.)
            {{/if}}

            <h4>Operations</h4>
            {{#if ops}}
            <table>
                <tr>
                    <th>Operation</th>
                    <th style="text-align: right">Number of Hits</th>
                    <th style="text-align: right">Cost in Gas Units</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each ops}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No operations to show.)
            {{/if}}
            <br />
            {{#if methods}}
            <table>
                <tr>
                    <th>Methods (gas including children)</th>
                    <th style="text-align: right">Number of Hits</th>
                    <th style="text-align: right">Cost in Gas Units</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each methods}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No methods to show.)
            {{/if}}
            <br />
            {{#if methods_self}}
            <table>
                <tr>
                    <th>Methods (only local gas)</th>
                    <th style="text-align: right">Number of Hits</th>
                    <th style="text-align: right">Cost in Gas Units</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each methods_self}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No methods to show.)
            {{/if}}
        </details>

        <details class="subsection" open>
            <summary>
                <h3>IO ({{summary-io-gas}} gas units)</h3>
            </summary>
            <p>IO costs cover reading and writing data to storage.</p>

            <h4>State Reads</h4>
            {{#if reads}}
            <table>
                <tr>
                    <th>Resource Name</th>
                    <th style="text-align: right">Number of Hits</th>
                    <th style="text-align: right">Cost in Gas Units</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each reads}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No reads to show.)
            {{/if}}
            <h4>Ledger Writes</h4>
            <h5>Transaction Itself</h5>
            <table>
                <tr>
                    <th style="text-align: right">Cost in Gas Units</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#with transaction_write}}
                <tr>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/with}}
            </table>
            <h5>Events</h5>
            {{#if event_writes}}
            <table>
                <tr>
                    <th>Event Type</th>
                    <th style="text-align: right">Number of Hits</th>
                    <th style="text-align: right">Cost in Gas Units</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each event_writes}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No writes to show.)
            {{/if}}
            <h5>State Write Ops</h5>
            {{#if writes}}
            <table>
                <tr>
                    <th>Resource Name</th>
                    <th style="text-align: right">Number of Hits</th>
                    <th style="text-align: right">Cost in Gas Units</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each writes}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{hits}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No writes to show.)
            {{/if}}
        </details>

        <details class="subsection" open>
            <summary>
                <h3>Storage ({{summary-storage-fee}} APT)</h3>
            </summary>
            <p>The storage fees cover the extended-term storage of states and events and are assessed at a fixed price
                in APT.</p>

            <h4>Transaction</h4>
            {{storage-txn}} APT{{#if storage-txn-percentage}}, {{storage-txn-percentage}} of the total cost for
            storage.{{/if}}
            <h4>States</h4>
            {{#if storage-writes}}
            <table>
                <tr>
                    <th>Path</th>
                    <th style="text-align: right">Cost in APT</th>
                    <th style="text-align: right">Percentage</th>
                    <th style="text-align: right">Refund in APT</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each storage-writes}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{cost-percentage}}</td>
                    <td style="text-align: right">{{refund}}</td>
                    <td style="text-align: right">{{refund-percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{else}}
            (No state changes to show.)
            {{/if}}
            <h4>Events</h4>
            {{#if storage-events}}
            <table>
                <tr>
                    <th>Name</th>
                    <th style="text-align: right">Cost in APT</th>
                    <th style="text-align: right">Percentage</th>
                </tr>
                {{#each storage-events}}
                <tr>
                    <td>{{name}}</td>
                    <td style="text-align: right">{{cost}}</td>
                    <td style="text-align: right">{{cost-percentage}}</td>
                </tr>
                {{/each}}
            </table>
            {{storage-event-discount}}
            {{else}}
            (No events to show.)
            {{/if}}
        </details>
    </details>

    <details open>
        <summary>
            <h2>Memory Usage</h2>
        </summary>
        Peak memory usage during transaction execution: {{peak-memory-usage}}.<br><br>

        Note: This is measured in abstract value size, which does not map 1:1 to bytes.
    </details>

    <details open>
        <summary>
            <h2>Full Execution Trace</h2>
        </summary>
        {{#if trace-is-large}}
        <p>Large trace ({{trace-line-count}} lines)</p>
        <div id="trace-buttons">
            <button id="load-trace-btn" onclick="loadTrace()">Load Trace</button>
            <button onclick="window.open('assets/trace.html', '_blank')" style="margin-left: 5px;">View Raw</button>
        </div>
        <div id="trace-container" style="display: none;">
            <p><button onclick="window.open('assets/trace.html', '_blank')">View Raw</button></p>
            <iframe id="trace-frame" style="width: 100%; height: max(800px, 80vh); border: 1px solid black;"></iframe>
        </div>
        <script>
            function loadTrace() {
                const btn = document.getElementById('load-trace-btn');
                const buttons = document.getElementById('trace-buttons');
                const container = document.getElementById('trace-container');
                const frame = document.getElementById('trace-frame');

                btn.textContent = 'Loading...';
                btn.disabled = true;

                frame.src = 'assets/trace.html';
                frame.onload = function () {
                    container.style.display = 'block';
                    buttons.style.display = 'none';
                };
                frame.onerror = function () {
                    btn.textContent = 'Failed to load trace';
                };
            }
        </script>
        {{else}}
        <p><button onclick="window.open('assets/trace.html', '_blank')">View Raw</button></p>
        <iframe src="assets/trace.html"
            style="width: 100%; height: max(800px, 80vh); border: 1px solid black;"></iframe>
        {{/if}}
    </details>

    <footer>
        <p>Generated by the Aptos Gas Profiler</p>
    </footer>
</body>

</html>