# Fungible Asset System

<details>
<summary>Relevant source files</summary>

The following files were used as context for generating this wiki page:

- [aptos-move/framework/aptos-framework/doc/fungible_asset.md](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/doc/fungible_asset.md)
- [aptos-move/framework/aptos-framework/doc/object.md](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/doc/object.md)
- [aptos-move/framework/aptos-framework/doc/primary_fungible_store.md](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/doc/primary_fungible_store.md)
- [aptos-move/framework/aptos-framework/sources/create_signer.move](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/create_signer.move)
- [aptos-move/framework/aptos-framework/sources/fungible_asset.move](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move)
- [aptos-move/framework/aptos-framework/sources/fungible_asset.spec.move](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.spec.move)
- [aptos-move/framework/aptos-framework/sources/object.move](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/object.move)
- [aptos-move/framework/aptos-framework/sources/object.spec.move](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/object.spec.move)
- [aptos-move/framework/aptos-framework/sources/primary_fungible_store.move](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/primary_fungible_store.move)
- [aptos-move/framework/aptos-framework/sources/primary_fungible_store.spec.move](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/primary_fungible_store.spec.move)
- [aptos-move/framework/aptos-framework/tests/simple_dispatchable_token_pfs_tests.move](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/tests/simple_dispatchable_token_pfs_tests.move)

</details>



The Fungible Asset System provides a framework for creating, managing, and transferring fungible assets in Aptos. Fungible assets are interchangeable units where each unit is equivalent to any other unit of the same type (e.g., cryptocurrencies, tokens). This system builds on the [Object Model](#2.1) to provide a comprehensive solution for on-chain assets.

For information about the specific implementation of APT (the Aptos coin), see the native Coin module documentation.

## Core Components

```mermaid
classDiagram
    class Metadata {
        name: String
        symbol: String
        decimals: u8
        icon_uri: String
        project_uri: String
    }
    
    class FungibleAsset {
        metadata: Object<Metadata>
        amount: u64
    }
    
    class FungibleStore {
        metadata: Object<Metadata>
        balance: u64
        frozen: bool
    }
    
    class Supply {
        current: u128
        maximum: Option<u128>
    }
    
    class MintRef {
        metadata: Object<Metadata>
    }
    
    class BurnRef {
        metadata: Object<Metadata>
    }
    
    class TransferRef {
        metadata: Object<Metadata>
    }
    
    Metadata -- Supply : manages
    FungibleAsset -- Metadata : references
    FungibleStore -- Metadata : holds
    MintRef -- Metadata : references
    BurnRef -- Metadata : references
    TransferRef -- Metadata : references
```

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:124-139](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L124-L139), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:147-156](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L147-L156), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:176-181](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L176-L181), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:183-187](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L183-L187), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:189-192](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L189-L192), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:204-207](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L204-L207)

### Key Components

1. **Metadata**: Holds information about a fungible asset (name, symbol, decimals, etc.)
2. **FungibleAsset**: Represents a specific amount of a fungible asset (ephemeral, must be deposited)
3. **FungibleStore**: Stores fungible assets for an object or account
4. **Supply**: Tracks current and maximum supply
5. **References**:
   - **MintRef**: Capability to mint new assets
   - **BurnRef**: Capability to burn assets
   - **TransferRef**: Capability to transfer assets or freeze/unfreeze stores

## Fungible Asset Lifecycle

```mermaid
flowchart TD
    A["Create Object"] --> B["Add Fungibility\n(add_fungibility)"]
    B --> C["Generate References\n(generate_mint_ref, etc.)"]
    C --> D["Create Stores\n(create_store)"]
    D --> E["Mint Assets\n(mint, mint_to)"]
    E --> F["Transfer Assets\n(transfer, withdraw, deposit)"]
    E --> G["Burn Assets\n(burn, burn_from)"]
```

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:266-307](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L266-L307), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:472-516](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L472-L516)

## Creating Fungible Assets

To create a fungible asset:

```mermaid
sequenceDiagram
    participant Creator
    participant Object as Object System
    participant FA as Fungible Asset System
    
    Creator->>Object: Create object
    Creator->>FA: add_fungibility(name, symbol, etc.)
    FA->>FA: Create metadata and supply resources
    Creator->>FA: generate_mint_ref()
    Creator->>FA: generate_burn_ref()
    Creator->>FA: generate_transfer_ref()
    Creator->>FA: create_store(metadata)
```

The process involves:

1. Create an object using the Object System
2. Call `add_fungibility` with metadata information
3. Generate references (MintRef, BurnRef, TransferRef)
4. Create stores for the asset

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:266-307](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L266-L307), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:472-516](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L472-L516), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:821-843](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L821-L843)

## Core Operations

### Minting

```mermaid
sequenceDiagram
    participant Owner
    participant MintRef
    participant Supply
    participant Store as FungibleStore
    
    Owner->>MintRef: mint(amount)
    MintRef->>Supply: increase_supply(amount)
    MintRef->>MintRef: Create FungibleAsset
    MintRef->>Store: deposit(asset)
    Store-->>Store: Emit Deposit event
```

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:1037-1067](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L1037-L1067)

### Transferring

```mermaid
sequenceDiagram
    participant Sender
    participant FA as Fungible Asset
    participant SenderStore as Sender's Store
    participant ReceiverStore as Receiver's Store
    
    Sender->>FA: transfer(from, to, amount)
    FA->>SenderStore: withdraw(amount)
    SenderStore-->>SenderStore: Emit Withdraw event
    FA->>ReceiverStore: deposit(asset)
    ReceiverStore-->>ReceiverStore: Emit Deposit event
```

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:809-817](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L809-L817)

### Burning

```mermaid
sequenceDiagram
    participant Owner
    participant BurnRef
    participant Supply
    participant Store as FungibleStore
    
    Owner->>BurnRef: burn_from(store, amount)
    BurnRef->>Store: withdraw(amount)
    Store-->>Store: Emit Withdraw event
    BurnRef->>Supply: decrease_supply(amount)
    BurnRef->>BurnRef: Destroy FungibleAsset
```

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:1096-1126](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L1096-L1126)

## Primary Fungible Store

The Primary Fungible Store system provides deterministic stores for users, making it easier to manage fungible assets:

```mermaid
flowchart TD
    A["create_primary_store_enabled_fungible_asset()"] --> B["Store DeriveRefPod on Metadata Object"]
    B --> C["Use ensure_primary_store_exists() for operations"]
    C --> D1["transfer()"]
    C --> D2["withdraw()"]
    C --> D3["deposit()"]
    C --> D4["mint()"]
    C --> D5["burn()"]
```

Key benefits:
- Deterministic addresses for stores that can be derived from user addresses
- Automatic creation of stores when needed
- Simplified transfer process
- Common interface for all fungible asset operations

Sources: [aptos-move/framework/aptos-framework/sources/primary_fungible_store.move:37-59](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/primary_fungible_store.move#L37-L59), [aptos-move/framework/aptos-framework/sources/primary_fungible_store.move:62-72](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/primary_fungible_store.move#L62-L72)

### Transfer Flow with Primary Fungible Store

```mermaid
sequenceDiagram
    participant User1
    participant PFS as Primary Fungible Store
    participant FA as Fungible Asset System
    participant User2
    
    User1->>PFS: transfer(metadata, recipient, amount)
    PFS->>PFS: ensure_primary_store_exists(sender)
    PFS->>PFS: ensure_primary_store_exists(recipient)
    PFS->>FA: withdraw(sender_store, amount)
    Note over FA: Emits withdraw event
    FA->>FA: Create FungibleAsset
    PFS->>FA: deposit(recipient_store, fungible_asset)
    Note over FA: Emits deposit event
```

Sources: [aptos-move/framework/aptos-framework/sources/primary_fungible_store.move:220-231](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/primary_fungible_store.move#L220-L231), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:884-935](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L884-L935)

## Advanced Features

### Concurrent Operations

The system supports concurrent operations through:
- `ConcurrentSupply`: Tracks supply using aggregators for higher throughput
- `ConcurrentFungibleBalance`: Tracks balances using aggregators for higher throughput

These features enable better performance in high-concurrency scenarios by reducing contention.

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:117-120](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L117-L120), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:171-174](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L171-L174)

### Dispatchable Functionality

The system supports custom dispatch functions for:
- Withdrawals
- Deposits
- Balance derivation
- Supply derivation

This enables extensibility for specialized use cases and custom asset behavior.

```mermaid
flowchart TD
    A["register_dispatch_functions()"] --> B["Set custom logic for operations"]
    B --> C1["withdraw_function"]
    B --> C2["deposit_function"]
    B --> C3["derived_balance_function"]
    A --> D["Register with metadata object"]
```

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:327-406](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L327-L406), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:409-449](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L409-L449)

## Security Constraints

The system enforces several security constraints:

- **Owner-based access control**: Only store owners can withdraw assets (unless using a TransferRef)
- **Frozen store protection**: Frozen stores prevent unauthorized transfers
- **Type safety**: Only compatible assets can be deposited in a store
- **Supply limits**: Optional maximum supply is enforced
- **Metadata validation**: Operations validate metadata compatibility

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:886-890](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L886-L890), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:885](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L885)

## Resource Management

```mermaid
flowchart TD
    Create["create_store()"] --> Store["FungibleStore"]
    Store --> Extract["extract()"]
    Store --> Merge["merge()"]
    Store --> Zero["destroy_zero()"]
    Store --> Remove["remove_store()\n(if balance = 0)"]
```

The system supports:
- Creating stores for any object
- Removing stores (only if balance is zero)
- Extracting portions of fungible assets
- Merging fungible assets
- Destroying zero-balance fungible assets

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:821-843](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L821-L843), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:846-874](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L846-L874), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:1438-1457](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L1438-L1457)

## Integration with the Object System

The Fungible Asset System is built on top of the Object Model, leveraging its capabilities:

```mermaid
flowchart TD
    Object["Object System"] --> Constructor["ConstructorRef"]
    Constructor --> Add["add_fungibility()"]
    Add --> Metadata["Metadata Resource"]
    Add --> Supply["Supply Resource"]
    Constructor --> Refs["generate_*_ref() Functions"]
    Refs --> MintRef["MintRef"]
    Refs --> BurnRef["BurnRef"]
    Refs --> TransferRef["TransferRef"]
    Constructor --> StoreCreation["create_store()"]
    StoreCreation --> FungibleStore["FungibleStore Resource"]
```

This integration provides several benefits:
- Object-based storage for all fungible asset components
- Unified ownership model with other objects
- Capability-based security through references
- Resource groups for gas efficiency

Sources: [aptos-move/framework/aptos-framework/sources/fungible_asset.move:8-9](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L8-L9), [aptos-move/framework/aptos-framework/sources/fungible_asset.move:266-307](https://github.com/aptos-labs/aptos-core/blob/b9f89a19/aptos-move/framework/aptos-framework/sources/fungible_asset.move#L266-L307)

## Key Design Principles

1. **Separation of concerns**: Metadata, stores, and capabilities are distinct
2. **Capability-based security**: References provide controlled access to operations
3. **Extensibility**: Dispatchable functions allow custom behaviors
4. **Efficiency**: Concurrent operations and resource groups optimize gas usage
5. **User experience**: Primary stores simplify asset management