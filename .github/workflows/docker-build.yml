name: Build Docker Images

on:
  push:
    branches: [ main, ci/* ]
  workflow_dispatch:
    inputs:
      GIT_SHA:
        description: 'Git SHA to build'
        required: false
      FEATURES:
        description: 'Cargo features to enable'
        required: false
      PROFILE:
        description: 'Cargo build profile'
        required: false
        default: 'release'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push Images
        run: |
          export GIT_SHA=${GITHUB_SHA}
          export GIT_BRANCH=$(git symbolic-ref --short HEAD || echo "detached")
          export GIT_TAG=$(git tag -l --contains HEAD || echo "")
          export BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          export PROFILE=${PROFILE:-release}
          export FEATURES=${FEATURES:-""}
          export CARGO_TARGET_DIR="target/${FEATURES:-default}"
          export GHCR_ORG="movementlabsxyz"
          export IMAGE_TAG_PREFIX=""
          
          # Ensure we always have a valid tag by using the git SHA as a fallback
          if [[ -n "${GITHUB_REF#refs/heads/}" ]]; then
            export NORMALIZED_GIT_BRANCH_OR_PR=$(echo ${GITHUB_REF#refs/heads/} | sed -e 's/[^a-zA-Z0-9]/-/g')
          else
            export NORMALIZED_GIT_BRANCH_OR_PR=${GIT_SHA}
          fi
          
          docker/builder/docker-bake-rust-all.sh 